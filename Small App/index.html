<!doctype html>
<html>
  <head>
    <title>React Basics</title>
  </head>
  <style>
    .Container {
      border: 1px solid grey;
      height: 300px;
      width: 500px;
      overflow-y: auto;
    }
    .input-appear {
      display: inline-block;
    }
    .input-dissapear {
      display: none;
    }
    .todo-dissapear {
      display: none;
    }
    .todo-appear {
      display: inline-block;
    }
    .todo-done {
      color: green;
      text-decoration: underline;
    }
  </style>
  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/dayjs.js"></script>
    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">
      function App() {
        const [input, setInput] = React.useState("");
        const [todo, setTodo] = React.useState(
          JSON.parse(localStorage.getItem("todo")) || [],
        );
        const [isTyping, setIsTyping] = React.useState(false);
        const timerTyping = React.useRef(null);
        const radioRef = React.useRef(null);
        const [editText, seteditText] = React.useState("");
        const [itemId, setItemId] = React.useState(null);

        const [filter, setFilter] = React.useState("all");

        const [debounceInput, setDebounceInput] = React.useState("");
        const visibleTodo = React.useMemo(() => {
          if (filter === "active") return todo.filter((t) => !t.done);
          if (filter === "completed") return todo.filter((t) => t.done);
          return todo;
        }, [todo, filter]);

        React.useEffect(() => {
          const timerId = setTimeout(() => {
            setDebounceInput(input);
          }, 500);

          return () => {
            clearTimeout(timerId);
          };
        }, [input]);

        React.useEffect(() => {
          localStorage.setItem("todo", JSON.stringify(todo));
        }, [todo]);

        React.useEffect(() => {
          clearTimeout(timerTyping.current);

          if (input === "") {
            setIsTyping(false);
            return;
          }
          setIsTyping(true);

          timerTyping.current = setTimeout(() => {
            setIsTyping(false);
          }, 1000);

          return () => {
            clearTimeout(timerTyping.current);
          };
        }, [input]);

        return (
          <>
            <ChatInput
              input={input}
              setInput={setInput}
              setTodo={setTodo}
              todo={todo}
              radioRef={radioRef}
            />
            <button onClick={() => setFilter("all")}>All</button>
            <button onClick={() => setFilter("active")}>Active</button>
            <button onClick={() => setFilter("completed")}>Completed</button>
            <TodoList
              setTodo={setTodo}
              todo={visibleTodo}
              isTyping={isTyping}
              setIsTyping={setIsTyping}
              editText={editText}
              seteditText={seteditText}
              itemId={itemId}
              setItemId={setItemId}
              input={input}
              setInput={setInput}
              radioRef={radioRef}
            />
            <div>Debounce 500ms :{debounceInput}</div>
          </>
        );
      }

      function ChatInput({
        input,
        setInput,
        todo,
        setTodo,
        complete,
        setComplete,
        radioRef,
      }) {
        function press(e) {
          setInput(e.target.value);
        }

        function sendMessage(e) {
          if (input === "") {
            return;
          }

          setTodo((prev) => [
            ...prev,
            {
              text: input.trim(),
              id: crypto.randomUUID(),
              done: false,
            },
          ]);

          setInput("");
          radioRef.current.focus();
        }
        function enterKey(e) {
          if (input === "") {
            return;
          }
          if (e.key === "Enter") {
            sendMessage();
          }
        }

        return (
          <>
            <input
              type="text"
              placeholder="todo"
              value={input}
              onChange={press}
              onKeyDown={enterKey}
              ref={radioRef}
            />
            <button onClick={sendMessage}>Send</button>
          </>
        );
      }

      function TodoList({
        todo,
        setTodo,
        isTyping,
        setIsTyping,
        complete,
        setComplete,
        editText,
        seteditText,
        itemId,
        setItemId,
        input,
        setInput,
        radioRef,
      }) {
        const containerRef = React.useRef(null);
        React.useEffect(() => {
          const containerElm = containerRef.current;
          containerElm.scrollTop = containerElm.scrollHeight;
        }, [todo.length]);

        function deleteButton(id) {
          setTodo((prev) => prev.filter((item) => item.id !== id));
        }

        function editButton(item) {
          setItemId(item.id);
          seteditText(item.text);
        }
        function editTheInput(e) {
          seteditText(e.target.value);
        }

        function saveButton(id) {
          setTodo((prev) =>
            prev.map((item) =>
              item.id === id ? { ...item, text: editText } : item,
            ),
          );
          setItemId(null);
          seteditText("");
          radioRef.current.focus();
        }
        function cancel(item) {
          seteditText("");
          setItemId(null);
        }
        function checked(id) {
          setTodo((prev) =>
            prev.map((item) =>
              item.id === id ? { ...item, done: !item.done } : item,
            ),
          );
        }

        return (
          <div ref={containerRef} className="Container">
            {todo.map((item) => {
              const editTextText = item.id === itemId;

              return (
                <div key={item.id}>
                  {!editTextText && (
                    <div className={item.done ? "todo-done" : "todo-not-done"}>
                      {item.text}
                    </div>
                  )}
                  {editTextText && (
                    <>
                      <input
                        autoFocus
                        type="text"
                        value={editText}
                        onChange={editTheInput}
                      />

                      <button onClick={() => saveButton(item.id)}>Save</button>
                      <button onClick={() => cancel(item)}>Cancel</button>
                    </>
                  )}
                  <input
                    type="checkbox"
                    name="subscribe"
                    onClick={() => checked(item.id)}
                  />
                  <button onClick={() => editButton(item)}>Edit</button>
                  <button onClick={() => deleteButton(item.id)}>Delete</button>
                </div>
              );
            })}
            {isTyping && <div>Typing....</div>}
          </div>
        );
      }

      const container = document.querySelector(".js-container");
      ReactDOM.createRoot(container).render(<App />);
    </script>
  </body>
</html>
