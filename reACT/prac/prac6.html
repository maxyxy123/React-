<!doctype html>
<html>
  <head>
    <title>React Basics</title>
  </head>
  <style></style>
  <body>
    <div class="js-container"></div>

    <script src="https://unpkg.com/supersimpledev/dayjs.js"></script>
    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">
      function App() {
        const [chatMessages, setChatMessages] = React.useState([]);
        const [input, setInput] = React.useState("");
        const inputRef = React.useRef(null);
        const [debounceInput, setDebounceInput] = React.useState("");
        const [isTyping, setIsTyping] = React.useState(false);
        let timerCurrentRef = React.useRef(null);
        const renderCount = React.useRef(0);
        const [undo, setUndo] = React.useState(true);
        let undoRef = React.useRef(null);
        React.useEffect(() => {
          clearTimeout(undoRef.current);
          console.log(undoRef.current);

          undoRef.current = setTimeout(() => {
            setUndo(false);
          }, 5000);
          return () => {
            if (undoRef.current) {
              clearTimeout(undoRef.current);
            }
          };
        }, [chatMessages.length]);

        React.useEffect(() => {
          renderCount.current++;
        }, [chatMessages]);
        React.useEffect(() => {
          clearTimeout(timerCurrentRef.current);

          if (input === "") {
            setIsTyping(false);
            return;
          }
          setIsTyping(true);

          timerCurrentRef.current = setTimeout(() => {
            setIsTyping(false);
          }, 1000);

          return () => {
            if (timerCurrentRef.current) {
              clearTimeout(timerCurrentRef.current);
            }
          };
        }, [input]);

        React.useEffect(() => {
          let timerId;
          timerId = setTimeout(() => {
            setDebounceInput(input);
          }, 500);
          return () => {
            clearTimeout(timerId);
          };
        }, [input]);

        function sendMessages() {
          if (input === "") {
            return;
          }

          setChatMessages((prev) => [
            ...prev,
            {
              text: input,
              id: crypto.randomUUID(),
            },
          ]);
          setInput("");
          inputRef.current.focus();
        }

        function press(e) {
          if (e.key === "Enter") {
            sendMessages();
          }
        }
        return (
          <>
            <ChatInput
              keydown={press}
              reff={inputRef}
              input={input}
              setInput={setInput}
              isTyping={isTyping}
              setIsTyping={setIsTyping}
            />
            <button onClick={sendMessages}>send</button>
            <ChatMessages
              chatMessages={chatMessages}
              setChatMessages={setChatMessages}
              isTyping={isTyping}
              setIsTyping={setIsTyping}
              undo={undo}
              setUndo={setUndo}
            />
            <div>Delay 500ms: {debounceInput}</div>
            <div>How many times Chatmessages render:{renderCount.current}</div>
          </>
        );
      }

      function ChatInput({
        input,
        setInput,
        reff,
        keydown,
        isTyping,
        setIsTyping,
      }) {
        function chatInput(e) {
          setInput(e.target.value);
        }

        return (
          <div>
            <input
              onKeyDown={keydown}
              ref={reff}
              type="text"
              onChange={chatInput}
              value={input}
            />
          </div>
        );
      }
      function ChatMessages({
        chatMessages,
        setChatMessages,
        isTyping,
        setIsTyping,
        undo,
        setUndo,
      }) {
        const containerElm = React.useRef(null);
        React.useEffect(() => {
          const el = containerElm.current;
          el.scrollTop = el.scrollHeight;
        }, [chatMessages]);
        function undoButton() {
          setChatMessages((prev) => prev.slice(0, -1));
          console.log(chatMessages);
          setUndo(true);
        }
        return (
          <div
            ref={containerElm}
            style={{
              height: 200,
              overflowY: "auto",
              border: "1px solid #ddd",
              padding: 8,
            }}
          >
            {chatMessages.length === 0 && <div>Please enter a message</div>}

            {chatMessages.map((prev) => (
              <React.Fragment key={prev.id}>
                <div>You :{prev.text}</div>
                {undo && <button onClick={undoButton}>Undo</button>}
              </React.Fragment>
            ))}
            {isTyping && <div>Typing....</div>}
          </div>
        );
      }

      const container = document.querySelector(".js-container");
      ReactDOM.createRoot(container).render(<App />);
    </script>
  </body>
</html>
